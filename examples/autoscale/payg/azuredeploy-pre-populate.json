{
    "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion":"1.3.0.0",
    "parameters":{
        "templateBaseUrl":{
            "defaultValue":"https://cdn.f5.com/product/cloudsolutions/",
            "metadata":{
                "description":"The publicly accessible URL where the linked ARM templates are located."
            },
            "type":"string"
        },
        "artifactLocation":{
            "defaultValue":"[concat('f5-azure-arm-templates-v2/v', deployment().properties.template.contentVersion, '/examples/')]",
            "metadata":{
                "description":"The directory, relative to the templateBaseUrl, where the modules folder is located."
            },
            "type":"string"
        },
        "uniqueString":{
            "metadata":{
                "description":"REQUIRED - A prefix that will be used to name template resources. Because some resources require globally unique names, we recommend using a unique value."
            },
            "type":"string"
        },
        "tagValues":{
            "defaultValue":{
                "application":"APP",
                "cost":"COST",
                "environment":"ENV",
                "group":"GROUP",
                "owner":"OWNER"
            },
            "metadata":{
                "description":"Default key/value resource tags will be added to the resources in this deployment, if you would like the values to be unique adjust them as needed for each key."
            },
            "type":"object"
        }
    },
    "variables":{
        "deploymentApiVersion": "2019-05-10",
        "contentVersion": "[deployment().properties.template.contentVersion]",
        "uniqueString": "[toLower(parameters('uniqueString'))]",
        "adminUsername": "azureuser",

        "assignManagedIdentity": true,
        "builtInRoleType": "Contributor",
        "customRoleAssignableScopes": [],
        "customRoleDescription": "",
        "customRoleName": "",
        "customRolePermissions": [],
        "keyVaultName": "",
        "keyVaultPermissionsKeys": [],
        "keyVaultPermissionsSecrets": [],
        "secretName": "",
        "userAssignedIdentityName": "[concat(variables('uniqueString'), '-userIdentity')]"
    },
    "resources":[
        {
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"[variables('deploymentApiVersion')]",
            "condition":"[variables('assignManagedIdentity')]",
            "name":"accessTemplate",
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri":"[concat(parameters('templateBaseUrl'), parameters('artifactLocation'), 'modules/access/access.json')]",
                    "contentVersion":"[variables('contentVersion')]"
                },
                "parameters":{
                    "builtInRoleType":{
                        "value":"[variables('builtInRoleType')]"
                    },
                    "customRoleAssignableScopes":{
                        "value":"[variables('customRoleAssignableScopes')]"
                    },
                    "customRoleDescription":{
                        "value":"[variables('customRoleDescription')]"
                    },
                    "customRoleName":{
                        "value":"[variables('customRoleName')]"
                    },
                    "customRolePermissions":{
                        "value":"[variables('customRolePermissions')]"
                    },
                    "keyVaultName":{
                        "value":"[variables('keyVaultName')]"
                    },
                    "keyVaultPermissionsKeys":{
                        "value":"[variables('keyVaultPermissionsKeys')]"
                    },
                    "keyVaultPermissionsSecrets":{
                        "value":"[variables('keyVaultPermissionsSecrets')]"
                    },
                    "secretName":{
                        "value":"[variables('secretName')]"
                    },
                    "secretValue":{
                        "value":""
                    },
                    "userAssignedIdentityName":{
                        "value":"[variables('userAssignedIdentityName')]"
                    },
                    "tagValues":{
                        "value":"[parameters('tagValues')]"
                    }
                }
            }
        },
        {
            "type":"Microsoft.Resources/deployments",
            "condition":"[variables('provisionApp')]",
            "apiVersion":"[variables('deploymentApiVersion')]",
            "name":"appTemplate",
            "dependsOn":[
                "accessTemplate"
            ],
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri":"[concat(parameters('templateBaseUrl'), parameters('artifactLocation'), 'modules/telemetry/telemetry.json')]",
                    "contentVersion":"[variables('contentVersion')]"
                },
                "parameters":{
                    "uniqueString":{
                        "value":"[variables('uniqueString')]"
                    },
                    "userAssignManagedIdentity":{
                        "value":"[if(variables('assignManagedIdentity'), reference('accessTemplate').outputs.userAssignedIdentityId.value, '')]"
                    },
                    "azureDeploymentScriptUri":{
                        "value": "[concat(parameters('templateBaseUrl'), parameters('artifactLocation'), 'modules/telemetry/deployment-script.py')]"
                    }
                }
            }
        }
    ],
    "outputs":{
    }
}